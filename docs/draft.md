# 草稿

用纯前端静态网页 HTML、CSS、JS 实现一个任务管理、进度显示的应用程序。

- 最简、最少代码实现
- 模块化设计
- 数据保存在 IndexedDB
  - 邻接列表模型
  - 维护一个指向所有祖先的路径数组。
    当子任务更新时，可以通过事件冒泡或批量更新机制来维护这些缓存值，从而避免在渲染时进行昂贵的计算。
  - 实现页面间通信机制（如 BroadcastChannel API），当一个实例修改了数据，通知其他实例进行刷新。
- 用户可创建任务、编辑任务、导入任务和导出任务（或所有任务和数据）

## 术语

- 叶子任务：没有子任务的任务。
- 完全完成：
  对于非*叶子任务*：其所有子任务都完全完成且该任务的已完成量达到本次任务量且重复次数为 0。
  对于*叶子任务*：该任务的已完成量达到本次任务量且重复次数为 0。
- 已完成（数据结构）：重复次数为 0。
- 重复：
  如果重复模式不为无，则任务被*完全完成*后会重新开始，重复次数减一。
  如果该任务有*截止日期*，则*截止日期*变为下一次符合重复条件时的日期（所以遇到闰年或月末等情况时，*截止日期*的时间跨度会更长）。
- 已完成时和总时：
  已完成的任务所需的时间（分钟），完成所有任务所需的时间（分钟）。
  对于非*叶子任务*：已完成时 = 子任务已完成时之和，总时 = 子任务总时之和；
  对于*叶子任务*：已完成时 = `已完成量 * 单次时间`，总时 = `本次任务量 * 单次时间`。

## 结构

- 根：总进度记录器
  - 标题
  - 进度：`已完成时 / 总时`
- 一个任务包含：
  - 任务描述
  - 单次时间（仅*叶子任务*）：x 分钟（加一完成量所需用时）
  - （子）任务（嵌套任务，可选）（可通过导入任务来添加子任务树）
  - 已完成量：这个任务被完成了几次
  - 本次任务量：本次需完成次数
  - 截止日期：
    - 无：父任务存在截止日期时，子任务截止日期默认认为与父任务一致
    - 有：任务的截止日期
  - 重复模式：
    - 无：任务不*重复*
    - 每 x 天：x = 1 时任务每天*重复*一次，x = 2 时任务每隔一天*重复*一次，以此类推
    - 每 x 周，星期 y：x 和上述相似，y 为星期几，可多选
    - 每 x 月，y 日：x 和上述相似，y 为日期，可多选
    - 每 x 年，：x 和上述相似
  - 重复次数：
    任务*重复*的次数，取值：0 ～ +∞

> 子任务也可以有子任务。
> 用户只能手动增加*叶子任务*的已完成量。
> 所有子任务*完全完成*时，父任务的已完成量自动增加。
>
> 第一次初始化时默认有一个任务：“规划任务”。

## 例

假如有两个月要背诵英语，一共 32 章节，每章节有 24 个单词和 8 个例句，计划每个月开始背 16 个章节，每天背一个章节：

- 根：英语学习
  - 任务：每月英语计划：「本次任务量：1，开始日期：（本月 1 日），截至日期：无，重复模式：每 1 月的 1 号，重复次数：2」
    - 任务：背一章单词：「本次任务量：1，截止日期：今天的日期，重复模式：每天，重复次数：16」
      - 任务：背个单词：「单次时间：1 分钟，本次任务量：24，截止日期：（父任务的截止日期）」
      - 任务：背个例句：「单次时间：5 分钟，本次任务量：8，截止日期：（父任务的截止日期）」

## 界面

所有实现应尽量采用 HTML 原生元素。
如：

1. 一个折叠块应使用 details/summary 元素，而非 div 加 JS 和 CSS；
2. 确认按钮和输入框在 form 中方便 JS 同时监听回车键确认和点击确认。

每个节点（根和任务）都显示一个进度条：`已完成时 / 总时`；

### 控件

- 任务卡片：展示任务的基本信息和“完成一次”按钮
  - 任务描述
  - 进度条和百分比
  - 子任务列表（如果有子任务）：就是内嵌的*任务列表*
  - 展开：
    - 截止日期
    - 剩余次数
    - “编辑”按钮：打开*编辑任务属性的表单弹窗*
  - “完成一次”按钮
- 任务列表：根据条件显示*任务卡片*
  - 搜索框
  - “创建任务”按钮
  - 进度条和百分比
  - _任务卡片_
- 编辑任务属性的表单弹窗：创建任务和编辑任务都使用这个表单
  - 任务描述
  - “创建子任务”按钮
  - 子任务列表（如果有子任务）：就是内嵌的*任务列表*
  - 单次时间
  - 已完成量
  - 本次任务量
  - 截止日期
  - 重复模式
  - 重复次数

### 主页面

- 菜单栏：
  - 根标题（可修改）
  - 总进度条和百分比
- 这一天：
  - 显示今天及今天之前截止的任务的*任务列表*（创建任务时自动将截止日期设为今日）
- 所有任务：
  - 显示所有任务的*任务列表*
- 已完成：
  - 显示已完成任务的*任务列表*（无“创建任务”按钮）

### 导出格式

JSON，包含版本号、导出时间、总标题和任务树。

```json
// JSON 导出格式示例
{
  "version": "1.0.0",
  "exportDate": "2024-01-01T00:00:00Z",
  "rootTitle": "我的任务进度",
  "tasks": [
    {
      "id": "uuid",
      "parentId": null, // 邻接列表模型
      "path": "root", // 用于快速查询
      "description": "任务描述"
      // ... 其他字段
    }
  ]
}
```
